<!DOCTYPE html>
<head>
    <script>
        const channel = new BroadcastChannel(new URLSearchParams(location.search).get('channel'));
        document.addEventListener('error', error => channel.postMessage('error', error));
        const log = (...args) => channel.postMessage({action: 'log', args});
        channel.postMessage({action: 'didChangeState', args: document.prerendering ? 'prerender' : 'discarded'});

        document.addEventListener('prerenderingchange', e =>
            channel.postMessage({action: 'didChangeState', args: 'activated'}));

        channel.addEventListener('message', async ({data: {action, args}}) => {
          switch (action) {
            case 'eval':
              const result = await (eval(`(${args})`))({log});
              channel.postMessage({action: 'didEval', args: result});
              break;
  
            case 'close':
              channel.close();
              window.close();
              break;
          }
        })
    </script>
</head>